
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="format-detection" content="telephone=no" />
</head>
<body>
  <button id="btnRecord">开始录制</button>
  <button disabled id="btnPlay">开始播放</button>
  <button disabled id="btnDownload">开始下载</button>
  
  <div id='log_'></div>
  <div id='audioContainer'></div>
</body>
<script src='./polyfill.js'></script>
<script>
  window.onerror = function(msg, url, link){
  log('报错信息', msg, {classList:['red'], focus:true});
  log('报错行数', link, {classList:['red'], focus:true});
};

var logFlag = true;
function log(key, value, options) {
  var log_ = document.getElementById('log_');
  options = options || {};
  var classList = options.classList || [];
  var keyHtml = '<span style="font-weight: bolder">' + (key || '') + '</span>';
  var outHtml = '<span class="' + classList.join(' ') + '">' + (value || '') + '</span>';
  if(options.focus){
    log_.innerHTML += keyHtml + ": " + outHtml + '<br>';
    return;
  }
  if(logFlag){
    log_.innerHTML += keyHtml + ": " + outHtml + '<br>';
    return;
  }
}
window.log = log;


var audioPlay = document.querySelector('audio#audioPlay');
var btnRecord = document.querySelector('button#btnRecord');
var btnPlay = document.querySelector('button#btnPlay');
var btnDownload = document.querySelector('button#btnDownload');

btnRecord.onclick = () => {
  if(btnRecord.textContent === '开始录制'){
    startRecord();
    btnRecord.textContent = '停止录制';
    btnPlay.disabled = true;
    btnDownload.disabled = true;
  }else{
    stopRecord();
    btnRecord.textContent = '开始录制';
    btnPlay.disabled = false;
    btnDownload.disabled = false;
  }
}
btnPlay.onclick = () => {
  audioPlay.play();
}
btnDownload.onclick = () => {
  var a = document.createElement('a');
  a.href = URL_;
  a.download = 'test';
  a.click();
}

function startRecord(){
  var log_ = document.getElementById('log_');
  log_.innerHTML = '';
  var audioContainer = document.getElementById('audioContainer');
  audioContainer.innerHTML = '';
  navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){
    mediaRecorder = new MediaRecorder(stream);
    n = ["start", "stop", "pause", "resume"]
    n.forEach(function(e) {
    mediaRecorder.addEventListener(e, x.bind(null, e))
    }),
    mediaRecorder.addEventListener('dataavailable', w)
    mediaRecorder.start() 
  });
}
function x(e) {
    log(mediaRecorder.state);
    log(mediaRecorder.mimeType);
}
function w(e) {
    var o = document.createElement("audio");
    o.controls = !0,
    URL_ = URL.createObjectURL(e.data),
    o.src = URL_,
    audioPlay = o;
    document.querySelector('div#audioContainer').appendChild(o)
}
function stopRecord() {
  mediaRecorder.stop();
  mediaRecorder.stream.getTracks().forEach(i => i.stop())
}
</script>
</html>
